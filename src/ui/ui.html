<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="style.css" />
<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
<script type="text/javascript">

activeTab = null;
nextId = 0;
progressBarBgMargin = 0;

$(document).ready(function() {

    var urlBar = $("#urlBar");
    urlBar.keypress(function(e) {
        return e.which != 13;
    });
    urlBar.keyup(function(e) {
        if (e.which == 13) {
            window.loadUrl();
            return false;
        }
        return true;
    });

    $("#urlBarBgCenter").click(function() {
        urlBar.focus();
    });

    urlBar.focusout(function() {
        activeTab._url = urlBar.text()
    });

    $("#plus").click(addEmptyTab);

    // Function stubs to debug UI on a browser
    if (!window._addTab) {
        var foo = function() {};
        window._addTab = foo;
        window._closeTab = foo;
        window._setCurrentTab = foo;
        window._toolBarHeightChanged = foo;
        window._loadUrl = foo;
        window._back = foo;
        window._forward = foo;
    }

    progressBarBgMargin = parseInt($("#progressBarFill").css("margin-left"));
    updateTabHeight();
    addEmptyTab();
});


function progressFinished()
{
    $("#progressBar").animate({opacity: 0.0}, 200);
}

function progressStarted()
{
    progressChanged(0);
    $("#progressBar").animate({opacity: 1.0}, 200);
}

function progressChanged(value)
{
    $("#progressBar").width(($("#urlBarBgFill").width() * value) + progressBarBgMargin);
}

function titleChanged(tabId, title)
{
    var tab = document.getElementById(String(tabId));
    if (tab)
        tab.firstChild.innerText = title;
}

function updateTabHeight()
{
    window._toolBarHeightChanged($("#tabBar").height() + 36);
}

function addEmptyTab()
{
    var tabBar = $("#tabBar");
    var barHeight = tabBar.height();

    var tabId = nextId++;
    var tabElem = document.createElement("span");
    tabElem.className = "tabDeco";
    var contents = document.createElement("span");
    contents.className = "tab";
    contents.appendChild(document.createTextNode("New Tab"));
    tabElem.appendChild(contents);

    var closeBtn = document.createElement("span");
    closeBtn.className = "tabClose";
    closeBtn.onclick = function() { closeTab(tabElem); };
    tabElem.appendChild(closeBtn);

    tabElem.id = String(tabId);
    tabElem.onclick = function() { selectTab(tabElem); }
    $("#plus").before(tabElem);

    tabElem._url = "http://";
    $("#urlBar").text(tabElem._url);

    if (barHeight < tabBar.height())
        updateTabHeight();

    window._addTab(tabId);
    selectTab(tabElem);
}

function selectTab(obj)
{
    if (activeTab == obj)
        return;

    if (activeTab)
        activeTab.className = "tabDeco";

    obj.className = "tabDeco active";
    activeTab = obj;
    window._setCurrentTab(parseInt(activeTab.id));
    var urlBar = document.getElementById("urlBar");
    urlBar.innerText = activeTab._url;
    if (urlBar.innerText == "http://") {
        urlBar.focus();
        var range = document.createRange();
        range.selectNodeContents(urlBar);
        range.collapse(false);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }
}

function closeTab(obj)
{
    var tabBar = $("#tabBar");
    var barHeight = tabBar.height();

    window._closeTab(parseInt(obj.id));
    $(obj).css("overflow", "hidden").animate({ opacity : 0, width: "20px"}, 300, "swing", function() {
        var nextTab = obj.nextSibling;
        $(this).remove();
        if (nextTab.id != "plus")
            selectTab(nextTab);

        if (barHeight > tabBar.height())
            updateTabHeight()
    });
}

function loadUrl()
{
    var urlBar = document.getElementById("urlBar");
    var url = urlBar.innerText;
    window._loadUrl(url);
    activeTab._url = url;
    urlBar.blur();
}

function goBack()
{
    window._back();
}

function goForward()
{
    window._forward();
}

</script>
</head>
<body>
    <div id="tabBar">
        <span class="tabDeco" id="plus"><span class="tab"><img src="images/plus.png" /></span></span>
    </div>
    <div class="toolBarRow">
        <div id="btnBack" onclick="goBack();"></div>
        <div id="btnForward" onclick="goForward();"></div>
        <div id="btnRefresh" onClick=""></div>

        <!-- Url bar -->
        <div id="urlBarBg">
            <div id="urlBarBgFill">
                <div id="progressBar">
                    <div id="progressBarFill">
                    </div>
                </div>
                <div id="urlBar" contentEditable></div>
            </div>
        </div>
    </div>

</body>
</html>
